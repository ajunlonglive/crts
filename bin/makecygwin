#!/bin/sh

# this script gets called by powershell on the windows appveyor build
# see: .builds/appveyor.yaml

# stderr messes up powershell, so redirect it to stdout
exec 2>&1

set -eux

build=build
install=crts_windows
buildtype=release

# install packages
curl -sO https://www.cygwin.com/setup-x86_64.exe

export PATH="/usr/local/bin:/usr/bin"

./setup-x86_64.exe -q -P meson,cmake,git,gcc,zip

# install glfw3
git clone https://github.com/glfw/glfw
git -C glfw checkout 3.3.2
mkdir -p glfw/build
cmake -S glfw -G Ninja -B glfw/build \
	-DWIN32=1 -DGLFW_BUILD_EXAMPLES=OFF  -DGLFW_BUILD_TESTS=OFF
cmake --build glfw/build --target glfw
ninja -C glfw/build install

# build

meson --prefix="$PWD/$install" \
	--bindir="$PWD/$install" \
	--buildtype="$buildtype" \
	-Dpkg_config_path=/usr/local/lib/pkgconfig \
	-Dbuild-tests=true \
	-Dopengl-ui=enabled \
	$build

ninja -C "$build" test install

ver="$(bin/version)"
bintray="https://api.bintray.com/content/annacrombie/crts/crts"

cp /bin/cygwin1.dll "$install"
zip -r "${install}.zip" "$install"

set +x
curl -T "${install}.zip" \
	-uannacrombie:$BINTRAY_API_KEY \
	"$bintray/${ver}/${install}.${ver}.zip?publish=1&override=1"
