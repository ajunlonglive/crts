#!/bin/sh -eu

die() {
	echo "$@" >&2
	exit 1
}

build_dir=build
debug=none
valgrind_tool=memcheck
leak_check=""

export CRTS_ASSET_PATH="build/assets/obj:build/assets:assets/shaders:assets/cfg:assets/obj:assets"
export CRTS_LOG_LVL=3

usage()
{
	printf "usage bin/crts [opts] <cmd> [cmd opts]
opts:
-v             run under valgrind
-t <tool>      valgrind tool to use (default: $valgrind_tool)
-l             --leak_check=full
-g             run under gdb
-b <build dir> use <build dir> instead of build as meson build dir
-h             show this message

cmds:
c|client       crts client
s|server       crts server
t|terragen     interactive terrain generator
s|snap         create images from save files
"
}

while getopts "vt:gb:h" opt; do
	case "$opt" in
	v) debug=valgrind;;
	t) valgrind_tool="$OPTARG";;
	g) debug=gdb;;
	b) build_dir="$OPTARG";;
	h) usage; exit;;
	?) die "invalid arg";;
	esac
done
shift "$((OPTIND-1))"

if [ "$#" -lt 1 ]; then
	die "please supply a command"
fi

case "$1" in
c|client) exe="$build_dir/client/client";;
s|server) exe="$build_dir/server/server";;
t|terragen) exe="$build_dir/terragen/terragen";;
p|snap) exe="$build_dir/util/snap";;
*) die "command $1 not found";;
esac

shift

case "$debug" in
valgrind)
	exec valgrind --tool="$valgrind_tool" "$exe" "$@"
	;;
gdb)
	exec gdb -q "$exe" -ex "r $@"
	;;
none)
	exec "$exe" "$@"
	;;
esac
