#!/bin/sh -eu

die() {
	echo "$@" >&2
	exit 1
}

build_dir=build
valgrind=""
valgrind_tool=memcheck

export CRTS_ASSET_PATH="build/assets/obj:build/assets:assets/shaders:assets/cfg:assets/obj:assets"
export CRTS_LOG_LVL=3

usage()
{
	printf "usage bin/crts [opts] <cmd> [cmd opts]
opts:
-v             run under valgrind
-t <tool>      valgrind tool to use (default: $valgrind_tool)
-b <build dir> use <build dir> instead of build as meson build dir
-h             show this message

cmds:
c|client       crts client
s|server       crts server
t|terragen     interactive terrain generator
s|snap         create images from save files
"
}

while getopts "vt:b:h" opt; do
	case "$opt" in
	v) valgrind=1;;
	t) valgrind_tool="$OPTARG";;
	b) build_dir="$OPTARG";;
	h) usage; exit;;
	?) die "invalid arg";;
	esac
done
shift "$((OPTIND-1))"

if [ "$#" -lt 1 ]; then
	die "please supply a command"
fi

case "$1" in
c|client) exe="$build_dir/client/client";;
s|server) exe="$build_dir/server/server";;
t|terragen) exe="$build_dir/terragen/terragen";;
p|snap) exe="$build_dir/util/snap";;
*) die "command $1 not found";;
esac

shift

if [ "$valgrind" ]; then
	exec valgrind --tool="$valgrind_tool" "$exe" "$@"
else
	exec "$exe" "$@"
fi
