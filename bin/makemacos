#!/bin/sh -eu

appname=crts
target_dir=build

icon=$target_dir/icon.icns
exe=$target_dir/client/crts

appdir="${target_dir}/${appname}.app"
rm -rf "$appdir"

exedir="$appdir/Contents/MacOS"
mkdir -p "$exedir"
resdir="${appdir}/Contents/Resources"
mkdir -p "$resdir"
infoplist="${appdir}/Contents/Info.plist"

echo '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleGetInfoString</key>
  <string>'$appname'</string>
  <key>CFBundleExecutable</key>
  <string>startup</string>
  <key>CFBundleIdentifier</key>
  <string>com.mochiro</string>
  <key>CFBundleName</key>
  <string>'$appname'</string>
  <key>CFBundleIconFile</key>
  <string>icon.icns</string>
  <key>CFBundleShortVersionString</key>
  <string>0.0.0</string>
  <key>CFBundleInfoDictionaryVersion</key>
  <string>0.0</string>
  <key>CFBundlePackageType</key>
  <string>APPL</string>
  <key>IFMajorVersion</key>
  <integer>0</integer>
  <key>IFMinorVersion</key>
  <integer>1</integer>
</dict>
</plist>' > "$infoplist"

echo '#!/bin/bash
cd "${0%/*}"
pwd
./crts -oopengl -i2 -k../Resources/cfg/keymap.ini' > "$exedir/startup"
chmod +x "$exedir/startup"

mkdir -p "$resdir/client/ui/opengl/"
cp -rf "client/ui/opengl/shaders" "$resdir/client/ui/opengl/"

cp "$icon" "$resdir"
cp -r cfg "$resdir"
cp "$exe" "$exedir"

libglfw=/opt/local/lib/libglfw.3.3.dylib
mkdir "$appdir/Contents/lib"
cp "$libglfw" "$appdir/Contents/lib"

install_name_tool -change /opt/local/lib/libglfw.3.dylib \
    @executable_path/../lib/libglfw.3.3.dylib \
    "$exedir/crts"
